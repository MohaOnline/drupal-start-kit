<?php
/**
 * @file
 * Code for the Topical feature.
 */

include_once 'dvg_topical.block.inc';
include_once 'dvg_topical.entity.inc';
include_once 'dvg_topical.context.inc';
include_once 'dvg_topical.features.inc';
include_once 'dvg_topical.dvg.user_permission.inc';

/**
 * Implements hook_form_FORM_ID_alter().
 */
function dvg_topical_form_views_form_topical_page_alter(&$form, &$form_state, $form_id) {
  $form['actions']['submit']['#submit'][] = '_dvg_global_cache_clear_all';
}

/**
 * Implements template_preprocess_node().
 *
 * Only display one highlight image per Topical items column.
 */
function dvg_topical_preprocess_node(&$variables) {
  $node = $variables['node'];

  // Render field_highlight_more_label as a link.
  if (!empty($variables['content']['field_highlight_more_label'])) {
    $field_highlight_more_label = field_get_items('node', $node, 'field_highlight_more_label', $node->language);
    $label = $field_highlight_more_label[0]['value'];
    $variables['content']['field_highlight_more_label'][0] = array(
      array(
        '#markup' => l($label, 'node/' . $node->nid, array('attributes' => array('class' => array('highlight-read-more')))),
      ),
    );
  }
}

/**
 * Implements hook_views_pre_render().
 *
 * Display a 'More news' link in the Topical view footer.
 */
function dvg_topical_views_pre_render(&$view) {
  if ($view->name == 'topical' && $view->current_display == 'frontpage_block') {
    $news_nid = functional_content_nid(_functional_content_item_name('news', 'block_news'));
    if ($news_nid) {
      $view->attachment_after .= l(t('More news'), 'node/' . $news_nid, array('attributes' => array('class' => array('more-news'))));
    }
  }
}

/**
 * Implements hook_dvg_requirements().
 */
function dvg_topical_dvg_requirements() {
  $requirements = array();

  $view_result = views_get_view_result('topical', 'frontpage_block');
  if (empty($view_result)) {
    $link = l(t('content'), 'node/add');
    $requirements['dvg_topical'] = array(
      'title' => t('Topical'),
      'value' => t('No topical items found. Add some topical !link.', array('!link' => $link)),
      'severity' => REQUIREMENT_ERROR,
    );
  }

  return $requirements;
}

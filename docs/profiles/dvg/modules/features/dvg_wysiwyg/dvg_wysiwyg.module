<?php
/**
 * @file
 * Code for the Wysiwyg feature.
 */

include_once 'dvg_wysiwyg.features.inc';
include_once 'dvg_wysiwyg.dvg.user_permission.inc';

/**
 * Implements hook_form_alter().
 */
function dvg_wysiwyg_form_alter(&$form, &$form_state, $form_id) {
  $form['#attached']['js'][] = drupal_get_path('module', 'dvg_wysiwyg') . '/dvg_wysiwyg.js';
}

/**
 * Implements hook_element_info_alter().
 */
function dvg_wysiwyg_element_info_alter(&$types) {
  $types['text_format']['#pre_render'][] = '_dvg_wysiwyg_pre_render_text_format';
}

/**
 * Callback to hide wysiwyg-clutter.
 */
function _dvg_wysiwyg_pre_render_text_format($element) {
  if (isset($element['format'])) {
    $element['format']['guidelines']['#access'] = FALSE;
    $element['format']['help']['#access'] = FALSE;
    $element['format']['#attributes']['class'][] = 'element-hidden';
  }
  return $element;
}

/**
 * Implements hook_wysiwyg_filter_info().
 */
function dvg_wysiwyg_filter_info() {
  $filters['dvg_date_token'] = array(
    'title' => t('DVG Date token Filter'),
    'description' => t('Allows you to write date tokens in the text.'),
    'process callback' => 'dvg_wysiwyg_filter_date_token_process',
  );

  return $filters;
}

/**
 * WYSIWYG date token filter process callback.
 */
function dvg_wysiwyg_filter_date_token_process($text, $filter, $format, $langcode, $cache, $cache_id) {
  // Only operate on valid UTF-8 strings. This is necessary to prevent cross
  // site scripting issues on Internet Explorer 6.
  if (!drupal_validate_utf8($text)) {
    return '';
  }

  return preg_replace_callback('/\[date(?::([^\]]+))?\]/', '_dvg_wysiwyg_filter_date_token_callback', $text);
}

/**
 * Callback function that returns a correctly formatted date.
 */
function _dvg_wysiwyg_filter_date_token_callback($m) {
  $type = 'dvg_short_date';
  $format = '';
  if (!empty($m[1])) {
    $type = 'custom';
    $format = $m[1];
  }

  return format_date(REQUEST_TIME, $type, $format);
}
